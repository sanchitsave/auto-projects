name: Deploy React Apps to Netlify

on:
  push:
    branches:
      - main
    paths:
      - 'test-app*/**'

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      # Step 1 â€“ Checkout repository
      - name: Checkout repository
        uses: actions/checkout@v3
        with:
          fetch-depth: 0   # Fetch all history so diff works reliably

      # Step 2 â€“ Set up Node.js
      - name: Set up Node.js
        uses: actions/setup-node@v3
        with:
          node-version: 18

      # Step 3 â€“ Detect all changed test-app folders
      - name: Detect changed app folders
        id: detect
        run: |
          CHANGED_DIRS=$(git diff --name-only ${{ github.event.before }} ${{ github.sha }} | grep '^test-app' | cut -d/ -f1 | sort -u)
          if [ -z "$CHANGED_DIRS" ]; then
            echo "No changed test-app folders detected."
            exit 1
          fi
          echo "changed_folders=$CHANGED_DIRS" >> $GITHUB_OUTPUT
          echo "Detected folders: $CHANGED_DIRS"

      # Step 4 â€“ Deploy each changed folder to Netlify
      - name: Deploy each changed folder
        run: |
          npm install -g netlify-cli jq
          for folder in ${{ steps.detect.outputs.changed_folders }}; do
            echo "ðŸ“¦ Installing dependencies for $folder"
            cd "$folder"
            npm install
            npm run build
            echo "ðŸš€ Deploying $folder to Netlify..."
            SITE_ID=$(netlify sites:create --name "${folder}-$(date +%s)" --json | jq -r '.site_id')
            netlify deploy \
              --dir=build \
              --prod \
              --auth=$NETLIFY_AUTH_TOKEN \
              --site=$SITE_ID
            cd ..
          done
        env:
          NETLIFY_AUTH_TOKEN: ${{ secrets.NETLIFY_AUTH_TOKEN }}
